"""
Find ONLY content that was actually generated by AI
(where section_description was created AFTER ai_audit)
"""

import psycopg2
from datetime import timedelta

POSTGRES_URL = "postgresql://usr_teleport_reader@localhost:51329/procurement_prod"

conn = psycopg2.connect(POSTGRES_URL)
cursor = conn.cursor()

print("="*70)
print("FINDING GENUINE AI-GENERATED CONTENT")
print("="*70)

# Find sections created AFTER AI audit (within reasonable time window)
cursor.execute("""
    SELECT 
        a.id as ai_id,
        a.prompt,
        a.project_id,
        a.created_at as ai_time,
        sd.id as section_id,
        sd.created_at as section_time,
        EXTRACT(EPOCH FROM (sd.created_at::timestamp - a.created_at::timestamp)) as seconds_diff,
        sd.description
    FROM ai_audit a
    JOIN section_description sd ON a.project_id = sd.project_id
    WHERE sd.created_at::timestamp > a.created_at::timestamp
      AND sd.created_at::timestamp < (a.created_at::timestamp + INTERVAL '1 hour')
      AND sd.description IS NOT NULL
    ORDER BY a.created_at DESC
    LIMIT 20
""")

results = cursor.fetchall()

print(f"\nFound {len(results)} sections created AFTER their AI prompt:")
print("-"*70)

if results:
    for ai_id, prompt, pid, ai_time, sid, sec_time, diff, description in results:
        print(f"\n✓ AI Audit #{ai_id}")
        print(f"  Prompt: {prompt[:60]}...")
        print(f"  AI created: {ai_time}")
        print(f"  Section created: {sec_time}")
        print(f"  Time diff: {diff:.1f} seconds later")
        print(f"  Content preview: {description[:150]}...")
else:
    print("\n⚠️  NO sections found that were created after AI prompts!")
    print("   This suggests AI might not be generating section_description content")
    print("   OR AI response is stored somewhere else")

# Check what ai_audit actually tracks
print("\n" + "="*70)
print("WHAT DOES AI_AUDIT ACTUALLY TRACK?")
print("="*70)

cursor.execute("""
    SELECT 
        a.id,
        a.prompt,
        a.project_id,
        a.created_at,
        p.title as project_title,
        p.created_at as project_created
    FROM ai_audit a
    JOIN project p ON a.project_id = p.id
    ORDER BY a.created_at DESC
    LIMIT 5
""")

print("\nRecent AI Audits:")
for ai_id, prompt, pid, ai_time, ptitle, proj_time in cursor.fetchall():
    print(f"\nAI #{ai_id}: {prompt[:50]}...")
    print(f"  Project: {ptitle}")
    print(f"  AI time: {ai_time}")
    print(f"  Project created: {proj_time}")
    if proj_time and ai_time:
        if proj_time > ai_time:
            print(f"  ⚠️  Project created AFTER AI prompt!")
        else:
            print(f"  ℹ️  Project existed before AI prompt")

# Alternative: Maybe AI modifies project.summary or project.background?
print("\n" + "="*70)
print("CHECKING PROJECT FIELDS FOR AI CONTENT")
print("="*70)

cursor.execute("""
    SELECT 
        a.id as ai_id,
        a.prompt,
        p.summary,
        p.background,
        a.created_at as ai_time,
        p.updated_at as project_updated
    FROM ai_audit a
    JOIN project p ON a.project_id = p.id
    WHERE (p.summary IS NOT NULL OR p.background IS NOT NULL)
    ORDER BY a.created_at DESC
    LIMIT 5
""")

print("\nChecking if AI updates project.summary or project.background:")
for ai_id, prompt, summary, background, ai_time, proj_updated in cursor.fetchall():
    print(f"\nAI #{ai_id}: {prompt[:50]}...")
    print(f"  AI time: {ai_time}")
    print(f"  Project updated: {proj_updated}")
    if summary:
        print(f"  Summary: {summary[:150]}...")
    if background:
        print(f"  Background: {background[:150]}...")

conn.close()

print("\n" + "="*70)
print("CONCLUSION")
print("="*70)
print("""
We need to understand what ai_audit actually tracks:

1. If sections are created AFTER ai_audit → Those are AI-generated ✓
2. If sections existed BEFORE ai_audit → Not AI content ✗  
3. Maybe AI updates project.summary/background instead?
4. Or maybe ai_audit just tracks AI usage, not content generation?

NEXT STEP: Ask your team what ai_audit.prompt represents!
- Is it: "User asks AI to generate content" ?
- Or: "User uses AI feature to search/analyze existing content" ?
""")

