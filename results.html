<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Results - LLM Eval Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0e1117;
            color: #fafafa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #262730;
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
        }

        .nav-link {
            color: #58a6ff;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .nav-link:hover {
            background: #1c1f26;
        }

        .reset-btn {
            background: #da3633;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .reset-btn:hover {
            background: #c92a2a;
        }

        .reset-btn:disabled {
            background: #4a4a4a;
            cursor: not-allowed;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: #1c1f26;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #262730;
        }

        .metric-label {
            font-size: 14px;
            color: #8b949e;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: #fafafa;
        }

        .metric-caption {
            font-size: 12px;
            color: #8b949e;
            margin-top: 4px;
        }

        .table-container {
            background: #1c1f26;
            border-radius: 8px;
            border: 1px solid #262730;
            overflow: hidden;
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid #262730;
        }

        .table-header h2 {
            font-size: 20px;
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #161b22;
            padding: 12px 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 12px 16px;
            border-top: 1px solid #262730;
            font-size: 14px;
        }

        tr.review-row {
            cursor: pointer;
            transition: background 0.2s;
        }

        tr.review-row:hover {
            background: #161b22;
        }

        tr.expanded-content {
            display: none;
        }

        tr.expanded-content.visible {
            display: table-row;
        }

        .expand-icon {
            display: inline-block;
            margin-right: 8px;
            transition: transform 0.2s;
            color: #58a6ff;
        }

        tr.review-row.expanded .expand-icon {
            transform: rotate(90deg);
        }

        .content-detail {
            background: #0e1117;
            padding: 16px;
            border-radius: 6px;
            margin: 8px 0;
        }

        .content-detail h4 {
            color: #8b949e;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .content-detail .content-text {
            color: #e0e0e0;
            line-height: 1.5;
            max-height: 300px;
            overflow-y: auto;
        }

        .nested-reviews {
            background: #0e1117;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #1f6feb;
        }

        .nested-review-item {
            padding: 12px;
            border-bottom: 1px solid #262730;
            display: grid;
            grid-template-columns: 150px 100px 1fr 150px;
            gap: 12px;
        }

        .nested-review-item:last-child {
            border-bottom: none;
        }

        .nested-label {
            color: #8b949e;
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .nested-value {
            color: #e0e0e0;
            font-size: 13px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-acceptable {
            background: #238636;
            color: #fff;
        }

        .status-not-acceptable {
            background: #da3633;
            color: #fff;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #8b949e;
        }

        .error {
            background: #da3633;
            color: #fff;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .empty {
            text-align: center;
            padding: 60px 20px;
            color: #8b949e;
        }

        .truncate {
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .multiple-badge {
            background: #1f6feb;
            color: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä Review Results</h1>
        <div style="display: flex; gap: 12px; align-items: center;">
            <button id="resetBtn" class="reset-btn">üîÑ Regenerate Data Set</button>
            <a href="/" class="nav-link">‚Üê Back to Reviews</a>
        </div>
    </div>

    <div id="content">
        <div class="loading">Loading results...</div>
    </div>

    <script>
        async function loadResults() {
            try {
                const response = await fetch('/api/get-results');
                const data = await response.json();

                if (data.error) {
                    showError(data.error);
                    return;
                }

                if (!data.reviews || data.reviews.length === 0) {
                    showEmpty();
                    return;
                }

                displayResults(data);

            } catch (error) {
                showError('Error loading results: ' + error.message);
            }
        }

        function displayResults(data) {
            const reviews = data.reviews;
            
            // Calculate metrics
            const total = reviews.length;
            const acceptable = reviews.filter(r => r.acceptable).length;
            const notAcceptable = total - acceptable;
            const acceptablePct = total > 0 ? (acceptable / total * 100).toFixed(0) : 0;
            
            // Get unique organizations
            const organizations = new Set(reviews.map(r => r.organization_name).filter(Boolean));
            const orgsCount = organizations.size;

            // Group reviews by review_id
            const groupedReviews = {};
            reviews.forEach(r => {
                const id = r.review_id || r._id;
                if (!groupedReviews[id]) {
                    groupedReviews[id] = [];
                }
                groupedReviews[id].push(r);
            });

            // Sort groups by latest timestamp
            const sortedGroups = Object.values(groupedReviews).sort((a, b) => {
                const dateA = new Date(a[0].submitted_at || a[0].timestamp);
                const dateB = new Date(b[0].submitted_at || b[0].timestamp);
                return dateB - dateA;
            });

            // Build HTML
            let html = `
                <div class="metrics">
                    <div class="metric-card">
                        <div class="metric-label">Total Reviews</div>
                        <div class="metric-value">${total}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Acceptable</div>
                        <div class="metric-value">${acceptable}</div>
                        <div class="metric-caption">‚Üë ${acceptablePct}%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Not Acceptable</div>
                        <div class="metric-value">${notAcceptable}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Organizations</div>
                        <div class="metric-value">${orgsCount}</div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <h2>Recent Reviews (click to expand)</h2>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Project Title</th>
                                <th>Reviews</th>
                                <th>Status</th>
                                <th>Organization</th>
                                <th>Last Updated</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Render each group
            sortedGroups.forEach((group, idx) => {
                const firstReview = group[0];
                const prompt = firstReview.prompt || 'N/A';
                const truncatedPrompt = prompt.length > 60 ? prompt.substring(0, 60) + '...' : prompt;
                
                const latestTimestamp = firstReview.submitted_at || firstReview.timestamp;
                const formattedTime = latestTimestamp ? new Date(latestTimestamp).toLocaleString() : 'N/A';
                
                const org = firstReview.organization_name || 'Unknown';
                const reviewCount = group.length;
                
                // Calculate status summary for the group
                const acceptableCount = group.filter(r => r.acceptable).length;
                const statusSummary = reviewCount > 1 ? 
                    `${acceptableCount}/${reviewCount} acceptable` : 
                    (group[0].acceptable ? '‚úì Acceptable' : '‚úó Not Acceptable');
                
                const statusClass = acceptableCount === reviewCount ? 'status-acceptable' : 
                                   acceptableCount === 0 ? 'status-not-acceptable' : 
                                   'status-badge';

                html += `
                    <tr class="review-row" data-row-id="${idx}">
                        <td>
                            <span class="expand-icon">‚ñ∂</span>
                            ${truncatedPrompt}
                            ${reviewCount > 1 ? `<span class="multiple-badge">√ó${reviewCount}</span>` : ''}
                        </td>
                        <td>${reviewCount}</td>
                        <td><span class="status-badge ${statusClass}">${statusSummary}</span></td>
                        <td class="truncate">${org}</td>
                        <td>${formattedTime}</td>
                    </tr>
                    <tr class="expanded-content" data-content-id="${idx}">
                        <td colspan="5">
                            ${renderExpandedContent(group, firstReview)}
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('content').innerHTML = html;
            
            // Add click handlers for expandable rows
            document.querySelectorAll('.review-row').forEach(row => {
                row.addEventListener('click', function() {
                    const rowId = this.getAttribute('data-row-id');
                    const contentRow = document.querySelector(`tr.expanded-content[data-content-id="${rowId}"]`);
                    
                    this.classList.toggle('expanded');
                    contentRow.classList.toggle('visible');
                });
            });
        }

        function renderExpandedContent(group, firstReview) {
            let html = `
                <div class="content-detail">
                    <h4>Full Project Title</h4>
                    <div class="content-text">${firstReview.prompt || 'N/A'}</div>
                </div>
            `;

            if (group.length === 1) {
                // Single review
                const review = group[0];
                const timestamp = review.submitted_at || review.timestamp;
                const formattedTime = timestamp ? new Date(timestamp).toLocaleString() : 'N/A';
                const statusClass = review.acceptable ? 'status-acceptable' : 'status-not-acceptable';
                const statusText = review.acceptable ? '‚úì Acceptable' : '‚úó Not Acceptable';

                html += `
                    <div class="content-detail">
                        <h4>Review Details</h4>
                        <div class="content-text">
                            <p><strong>Reviewer:</strong> ${review.reviewer || 'Anonymous'}</p>
                            <p><strong>Status:</strong> <span class="status-badge ${statusClass}">${statusText}</span></p>
                            <p><strong>Timestamp:</strong> ${formattedTime}</p>
                            ${review.notes ? `<p><strong>Notes:</strong> ${review.notes}</p>` : ''}
                        </div>
                    </div>
                `;
            } else {
                // Multiple reviews - show nested
                html += `
                    <div class="content-detail">
                        <h4>Multiple Reviews (${group.length})</h4>
                        <div class="nested-reviews">
                `;

                group.forEach((review, idx) => {
                    const timestamp = review.submitted_at || review.timestamp;
                    const formattedTime = timestamp ? new Date(timestamp).toLocaleString() : 'N/A';
                    const statusClass = review.acceptable ? 'status-acceptable' : 'status-not-acceptable';
                    const statusText = review.acceptable ? '‚úì Acceptable' : '‚úó Not Acceptable';

                    html += `
                        <div class="nested-review-item">
                            <div>
                                <div class="nested-label">Reviewer ${idx + 1}</div>
                                <div class="nested-value">${review.reviewer || 'Anonymous'}</div>
                            </div>
                            <div>
                                <div class="nested-label">Status</div>
                                <div class="nested-value"><span class="status-badge ${statusClass}">${statusText}</span></div>
                            </div>
                            <div>
                                <div class="nested-label">Notes</div>
                                <div class="nested-value">${review.notes || 'No notes'}</div>
                            </div>
                            <div>
                                <div class="nested-label">Timestamp</div>
                                <div class="nested-value">${formattedTime}</div>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            return html;
        }

        function showError(message) {
            document.getElementById('content').innerHTML = `
                <div class="error">${message}</div>
            `;
        }

        function showEmpty() {
            document.getElementById('content').innerHTML = `
                <div class="empty">
                    <p>No reviews yet. <a href="/" class="nav-link">Start reviewing</a> to see results here.</p>
                </div>
            `;
        }

        // Reset reviews handler
        document.getElementById('resetBtn').addEventListener('click', async () => {
            if (!confirm('Regenerate data set? This will restore all reviews to the pending queue.\n\nAny completed reviews will remain in the results.')) {
                return;
            }

            const btn = document.getElementById('resetBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Regenerating...';

            try {
                const response = await fetch('/api/reset-reviews', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    // Clear all submitted review tracking when resetting
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith('submitted_')) {
                            localStorage.removeItem(key);
                        }
                    });
                    
                    alert(`‚úÖ Success!\n\nRegenerated ${result.count} reviews to pending queue.\n\nAll submission tracking has been cleared.`);
                    window.location.href = '/';
                } else {
                    alert('‚ùå Error: ' + (result.error || 'Unknown error'));
                    btn.disabled = false;
                    btn.textContent = 'üîÑ Regenerate Data Set';
                }

            } catch (error) {
                alert('‚ùå Error: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'üîÑ Regenerate Data Set';
            }
        });

        // Load results on page load
        loadResults();
    </script>
</body>
</html>

